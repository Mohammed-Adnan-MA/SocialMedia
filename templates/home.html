{% extends "layout.html" %}
{% block content %}
<!-- Still under development -->
<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>

  <div id="here-lied-posts">
  </div>  

    <script id="posts-template" type="text/x-handlebars-template">
        {% raw -%}
        {{#each comments}}
          {{#each ../commentUsername}}
            {{#if_eq [1] ../comment_author}}
                <h4>{{ [0] }}</h4>
            {{/if_eq}}
          {{/each}}
        {{/each}}
          {{#each posts}}
            <article class="media content-section">
                <img class="rounded-circle article-img" src="#">
                <div class="media-body">
                  
                  <div class="article-metadata">
        {%- endraw %}
                    <a class="mr-2" href="{{ url_for('account') }}">{% raw -%} {{lookup ../postUsername @index}} {%- endraw %}</a>
        {% raw -%}
                    <small class="text-muted">{{ post_date }}</small>
                  </div>
                  
                  <h2><a class="article-title" href="#"></a></h2>
                  <p class="article-content">{{ body }}</p>
                  <!-- Post Comments -->
                  <hr>
                  <div class="post-comment">
                
                    <div class="write">
                        <input type="text" placeholder="Write a comment...">
                    </div> 
                    <div class="post" >
                       <input type="submit" value="post" onsubmit="new_comment()">
                    </div> 
                  </div>

                  {{#each ../comments}}  
                    {{#if_eq post_comments ../id}}
                      
                      <div style="background-color:rgb(169, 166, 204);" class="comments" >
                          <div class="content">
                            <div class="picture">
                                    <img class="rounded-circle article-img" src="77.jpg">
                                </div>
                                    <div class="name">
                                          
                                      <h4>{{count ../../commentUsername}}</h4>
                                    
                                      
                                      <p>{{comment}}</p>
                                      {{comment_date}}
                                        
                                </div>
                          </div>                         
                      </div>
                      <hr>
                    {{/if_eq}}
                  {{/each}}
                </div>
            </article>
        {{/each}} 
      {%- endraw %}
    </script>     

    
     

    <script>
        $(document).ready(function() {
                  
          fetch(`${window.origin}/loadposts`, {
                method:"GET",
                dataType: 'json'
            })
            .then((res) => {
              if (!res.ok) {
                throw new Error("HTTP error, status = " + response.status);
              }
              return res.json();
            })
            .then((data) => {
              console.log(data);
              createHTML(data);
            })
            .catch((err)=> console.log(err));
        });   

        function createHTML(postsContent){
          var postsTemplate = document.querySelector("#posts-template").innerHTML;
          var compiledPostsTemplate = Handlebars.compile(postsTemplate);
          var postsGeneratedHTML = compiledPostsTemplate(postsContent);
          var postsContainer = document.querySelector("#here-lied-posts");
          postsContainer.innerHTML = postsGeneratedHTML;
        }


        //Handlebars.registerHelper("comment", function(x){
          //var html = "<ul>";
          //x.forEach(function(entry) {
            //if(entry.postComments.join()){
              //console.log(entry.postComments.join());
            //}
                     
                  
          //});
          //html += "</ul>";
          
          //console.log(html);
        //});
        
        var x = -1;
        Handlebars.registerHelper('count', function(counter) {
          x+=1;
          if(x==counter.length){
            x = 0;
          }
          else {
            console.log(x + " " + counter[x]);
            return(counter[x]);
          }
        });

        Handlebars.registerHelper('if_eq', function(a, b, opts) {
            //console.log(a + " " + b);
            if (a == b) {
                return opts.fn(this);
            } else {
                return opts.inverse(this);
            }
        });
</script>
{% endblock content %}
